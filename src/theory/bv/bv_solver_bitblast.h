/******************************************************************************
 * Top contributors (to current version):
 *   Mathias Preiner, Andrew Reynolds, Aina Niemetz
 *
 * This file is part of the cvc5 project.
 *
 * Copyright (c) 2009-2025 by the authors listed in the file AUTHORS
 * in the top-level source directory and their institutional affiliations.
 * All rights reserved.  See the file COPYING in the top-level source
 * directory for licensing information.
 * ****************************************************************************
 *
 * Bit-blasting solver that supports multiple SAT back ends.
 */

#include "cvc5_private.h"

#ifndef CVC5__THEORY__BV__BV_SOLVER_BITBLAST_H
#define CVC5__THEORY__BV__BV_SOLVER_BITBLAST_H

#include <memory>

#include "smt/env_obj.h"
#include "context/cdqueue.h"
#include "proof/eager_proof_generator.h"
#include "theory/bv/bv_solver.h"
#include "theory/bv/proof_checker.h"

namespace cvc5::internal {

namespace theory {
namespace bv {

class BitBlasterWrapper;
class NotifyResetAssertions;

/**
 * Bit-blasting solver with support for different SAT back ends.
 */
class BVSolverBitblast final : public BVSolver
{
 public:
  BVSolverBitblast(Env& env,
                   TheoryState& state,
                   TheoryInferenceManager& inferMgr);
  ~BVSolverBitblast() override = default;

  bool needsEqualityEngine(EeSetupInfo& esi) override;

  void preRegisterTerm(TNode n) override {}

  void postCheck(Theory::Effort level) override;

  bool preNotifyFact(TNode atom,
                     bool pol,
                     TNode fact,
                     bool isPrereg,
                     bool isInternal) override;

  TrustNode explain(TNode n) override;

  std::string identify() const override { return "BVSolverBitblast"; };

  void computeRelevantTerms(std::set<Node>& termSet) override;

  bool collectModelValues(TheoryModel* m,
                          const std::set<Node>& termSet) override;

  /**
   * Get the current value of `node`.
   *
   * The `initialize` flag indicates whether bits should be zero-initialized
   * if they were not bit-blasted yet.
   */
  Node getValue(TNode node, bool initialize) override;

 private:
  /** The Bitblaster wrapper containing the actual blaster, the SatSolver,
   *  and the CnfStream and many more. */
  std::unique_ptr<BitBlasterWrapper> d_bitblaster;

  /** Bit-blast queue for facts sent to this solver.
   *  Gets populated on preNotifyFact(). */
  context::CDQueue<Node> d_bbFacts;

  /** Bit-blast queue for user-level 0 input facts sent to this solver.
   *  Get populated on preNotifyFact(). */
  context::CDQueue<Node> d_bbInputFacts;

  /** Proof generator that manages proofs for lemmas generated by this class.
   *  Remains null if not proof producing.*/
  std::unique_ptr<EagerProofGenerator> d_epg;

  /** The BV proof rule checker; null if not proof producing. */
  std::unique_ptr<BVProofRuleChecker> d_bvProofChecker;

  /** Notifies when reset-assertion was called. */
  std::unique_ptr<NotifyResetAssertions> d_resetNotify;
};

}  // namespace bv
}  // namespace theory
}  // namespace cvc5::internal

#endif
